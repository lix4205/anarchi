
# This script is executed at the end of the installation
# Don't forget you are chrooted in the fresh install while it run
# Put your stuff at the end of this file..
# 
#
# Some variables you can use :
# 	Username : NAME_USER=
# 	Les services systemd SYSTD_SOFT=
# 	Le disque sur lequel grub sera installé GRUB_DISK=
# 	L'interface reseau choisie NFSROOT=
# 	L'environnement de bureau DE=
#	L'architecture de la distribution ARCH=
# 	Le display manager DM=
# 	Le codage clavier X11 $X11_KEYMAP=

# BEGIN USER CONFIG

ARCH_PACKAGES="$( [[ "$ARCH" == "x64" ]] && echo "x86_64" || echo "$ARCH" )"
CUSTOM_USER_SCRIPT="/tmp/files/custom.d/$NAME_USER"
# random background LIGHTDM
if [[ $DM == "lightdm" ]]; then
	IMG_BG=$(find "/tmp/files/imgs/" -maxdepth 1 -type f | shuf | head -n 1 )
	EXT_BG_NAME=$( echo "$IMG_BG" | sed "s/.*\.//")
	BG_NAME="bg.$EXT_BG_NAME"
	cp "$IMG_BG" /usr/share/pixmaps/$BG_NAME
	sed -i "s/.*background=.*/background=\/usr\/share\/pixmaps\/$BG_NAME/" "/etc/lightdm/lightdm-gtk-greeter.conf"                
fi
# END


# BEGIN GUI_EDITOR for edit pkgbuild in yaourt 
# Used to complete xinitrc for slim and nodm
declare -A binde=(
	[plasma]="startkde"
	[gnome]="gnome-session"
	[cinnamon]="cinnamon-session"
	[mate]="mate-session"
	[lxde]="startlxde"
	[xfce]="startxfce4"
	[lxqt]="startlxqt"
	[fluxbox]="startfluxbox"
	[enlightenment]="enlightenment_start"

)
# ${dm_editor} is a tab which contains the editor list associated with the DE
declare -A dm_editor=(
	[e_plasma]="kate"
	[e_gnome]="gedit"
	[e_mate]="pluma"
	[e_lxde]="leafpad"
	[e_xfce]="mousepad"
	[e_lxqt]="leafpad"
# 	[e_fluxbox]="nano"
)
[[ -z ${dm_editor[e_$DE]} ]] && GUI_EDITOR="${dm_editor[e_$DE]}" &&
sed -i "s/export VISUAL=.*/export VISUAL=\"\$(if [[ -n \$DISPLAY ]]; then echo '$GUI_EDITOR'; else echo 'nano'; fi)\"/" /home/*/.bashrc
# # USELESS echo -e "export VISUAL=\"\$(if [[ -n \$DISPLAY ]]; then echo '$GUI_EDITOR'; else echo 'nano'; fi)\""  >> "/etc/skel/.bashrc"
# # END
LOG_EXE="/tmp/anarchi.log"

# # BEGIN fstab perso & mount new entry...
# Pacman need architecture for i686 installation from x64 
# so we will use $pacman as pacman --arch (x86_64/i686)
pacman="pacman --arch $ARCH_PACKAGES"
yaourt="yaourt --arch $ARCH_PACKAGES"
# I use this directory to mount my NFS server...
DIR_SRV=/media/srv
# ...with this IP...
IP_SRV="192.168.1.5"
# Later, I'll copy my NAME_USER config from DIR_USR_CONF on my server...
DIR_USR_CONF=$DIR_SRV/confs
# DIR_USR_CONF=/tmp/files/confs
# DIR_USR_CONF=$DIR_SRV/users
# Default user conf
DEFAULT_USER="lix"
# Write in fstab
! cat /etc/fstab | grep $IP_SRV >> /dev/null && echo -e "# $IP_SRV:/ on $DIR_SRV\n$IP_SRV:/	$DIR_SRV	nfs    x-systemd.automount,x-systemd.device-timeout=1s   0 0" >> /etc/fstab
# # USER DIR Bind from srv on fstab
# echo "$DIR_USR_CONF                       /home            none    bind   0       0" >> /etc/fstab

[[ ! -e /media/srv ]] && mkdir -p /media/{srv,tmp} && echo "==> Creating directories /media/{srv,tmp}"
echo "==> Wait while mounting $DIR_SRV" && mount $DIR_SRV
# # END fstab

# BEGIN  install packages in files/de/yaourt.conf via AUR. 
# files/de/yaourt.conf is empty by default except when we install lxqt desktop ( qterminal is in AUR repository )
if [ "$LIST_YAOURT" != "" ]; then
	rep=
	while [[ "$rep" == "" ]]; do
		echo -en "\033[01;37m  -> Install AUR packages Y/n ?\033[00m ( $LIST_YAOURT ) "
		read -n 1 rep
		case "$rep" in 
			o|O|y|Y)
				echo "$LIST_YAOURT install" 
				su $NAME_USER -c "yaourt --arch $ARCH -Sy --noconfirm $LIST_YAOURT"
				break				
			;;
			n|N)
				break
			;;
			*) rep= ;;
		
		esac
	done
fi
# # BEGIN fill .bash_history with usefull command for starting
echo "
systemctl stop $DM
systemctl start $DM
systemctl start $NAME_USER
systemctl stop $NAME_USER
systemctl start dux
systemctl stop dux
systemctl stop media-srv.automount
systemctl daemon-reload
systemctl poweroff
systemctl reboot
ip addr
fdisk -l
df -h
du -h -d 1 .
mount /dev/sda1 /media/tmp
systemctl status $NFSROOT
su - $NAME_USER
modprobe -a vboxdrv vboxnetadp vboxnetflt vboxpci
rmdir /var/cache/pacman/pkg/ && ln -s $DIR_SRV/packages/$ARCH/pkg/ /var/cache/pacman/
mv /var/cache/pacman/pkg/* /media/srv/packages/x64/pkg/
rm /var/cache/pacman/pkg/*
ls -l /var/cache/pacman/pkg
pacman -Syu
journalctl -fn 50
journalctl -fn 50 -u $DM
bash $DIR_SRV/scripts/arch-utils.sh
mount $DIR_SRV/


" > /root/.bash_history
# # END .bash_history

echo "DIR_SRV=/media/srv
DIR_SCR=\$DIR_SRV/scripts" >> /root/.bashrc

# BEGIN X11 KEYBOARD CONFIG ( Ctrl + Alt + backspace kill xserver)
# It's for a french keyboard ! Remove latin9 !!!
echo -e "Section \"InputClass\"\n\tIdentifier \"system-keyboard\"\n\tMatchIsKeyboard \"on\"\n\tOption \"XkbLayout\" \"${X11_KEYMAP}\"\n\tOption \"XkbModel\" \"pc105\"\n\tOption \"XkbVariant\" \"latin9\"\n\tOption \"XkbOptions\" \"terminate:ctrl_alt_bksp\"\nEndSection" > /etc/X11/xorg.conf.d/00-keyboard.conf
# END

# BEGIN configurations by the desktop-environnement
		echo -n "==> Installation de "
case $DE in
	plasma)
		echo -n "yakuake"
		$pacman -Sy --noconfirm --needed yakuake >> $LOG_EXE 2>&1 && echo "...ok" || echo -e "...echec !\n==> Consultez $LOG_EXE  pour plus de détail"
	;;
	# Cinnamon has tilda as terminal
	mate|xfce|gnome) 
		echo -n "tilda"
		$pacman -Sy --noconfirm --needed tilda >> $LOG_EXE 2>&1 && echo "...ok" || echo -e "...echec !\n==> Consultez $LOG_EXE  pour plus de détail"
	;;
	lxqt) : ;;
# 		fluxbox)
# 			su $NAME_USER -c "echo \"exec startfluxbox\" > /home/$NAME_USER/.xinitrc" 
# 		;;
esac
case $DM in
	sddm)
# 			$pacman -Sy --noconfirm yakuake
#			Generate sddm.conf and change theme
		sddm --example-config > /etc/sddm.conf
		sed -i "s/maui/breeze/" /etc/sddm.conf
	;;
# 		gdm) : ;;
# 		lightdm) : ;;
# 		lxdm) : ;;
	slim) :
		su $NAME_USER -c "echo \"exec ${binde[$DE]}\" > /home/$NAME_USER/.xinitrc"
	;;
	nodm) :
		sed -i "s/^NODM_USER=.*/NODM_USER=$NAME_USER/" /etc/nodm.conf
		sed -i "s/^NODM_XSESSION=.*/NODM_XSESSION=\/home\/$NAME_USER\/.xinitrc/" /etc/nodm.conf
# 			echo -e "NODM_USER=$NAME_USER\nNODM_XSESSION=/home/$NAME_USER/.xinitrc" >> /etc/nodm.conf
# 			su $NAME_USER -c "echo \"exec startfluxbox\" > /home/$NAME_USER/.xinitrc" 
		su $NAME_USER -c "echo \"exec ${binde[$DE]}\" > /home/$NAME_USER/.xinitrc && chmod +x /home/$NAME_USER/.xinitrc" 
# 			chown 
		echo "#%PAM-1.0

auth      include   system-login
account   include   system-login
password  include   system-login
session   include   system-login" > "/etc/pam.d/nodm"
	;;
esac
# END


# BEGIN configuration by $NAME_USER 

# BEGIN lix CONFIG
if [[ -e "$CUSTOM_USER_SCRIPT" ]]; then
    source "$CUSTOM_USER_SCRIPT"
    if [[ -e $DIR_USR_CONF/$NAME_USER ]]; then
        su $NAME_USER -c "bash /tmp/files/extras/copyconf.sh \"$DIR_USR_CONF/$NAME_USER\" $NAME_USER $DE" 
        su - $NAME_USER -c "cp -PR $DIR_USR_CONF/$NAME_USER/* ."
    else
        su $NAME_USER -c "bash /tmp/files/extras/copyconf.sh \"$DIR_USR_CONF/$DEFAULT_USER\" $NAME_USER $DE"; 
        su - $NAME_USER -c "cp -PR $DIR_USR_CONF/$DEFAULT_USER/* ."
    fi
fi

# END

[[ $? -eq 0 ]] && echo "==> La configuration de $NAME_USER à été créée !"
# Some aliases
su $NAME_USER -c "echo -e \"# Some aliases\\nalias lsl=\\\"ls -l\\\"\nalias lsa=\\\"ls -a\\\" \" >> /home/$NAME_USER/.bashrc"

# On force le démontager du partage
until ! mountpoint -q $DIR_SRV; do
        
        umount $DIR_SRV >> /dev/null 2>&1
        sleep 0.5
done

# END 

